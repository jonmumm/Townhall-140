((function(){TownHall140.Collections.EventManager=Backbone.Collection.extend({initialize:function(){var a;a=app.get("show_id"),$(document).bind("toStage",$.proxy(this.onToStage,this)),$(document).bind("offStage",$.proxy(this.onOffStage,this)),$.getJSON("/event/current",{show_id:app.get("show_id")},$.proxy(this.onEventsInit,this)),app.get("pusher").subscribe(""+a).bind("state",$.proxy(this.onEventNew,this));if(app.get("is_moderator"))return app.get("session").addEventListener("streamCreated",$.proxy(this.onStreamCreate,this))},onEventsInit:function(a){var b,c,d,e;e=[];for(c=0,d=a.length;c<d;c++)b=a[c],e.push(this.processEvent(b));return e},onEventNew:function(a){return this.processEvent(a)},processEvent:function(a){return this.get(a.stream_id)?this.get(a.stream_id).set({state:a.state}):this.add(new TownHall140.Models.Event({id:a.stream_id,state:a.state}))},onToStage:function(a,b){return this.postEvent(b.id,"guest")},onOffStage:function(a,b){return this.postEvent(b.id,"queue")},onStreamCreate:function(a){var b,c;return c=a.streams[0],c.connection.connectionId===app.get("session").connection.connectionId?b="host":b="queue",this.postEvent(c.streamId,b)},postEvent:function(a,b){return $.ajax({type:"post",url:"/event",data:{show_id:app.get("show_id"),stream_id:a,state:b}})}})})).call(this)