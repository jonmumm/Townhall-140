((function(){TownHall140.Collections.EventManager=Backbone.Collection.extend({initialize:function(){var a;a=app.get("show").id,$(document).bind("toStage",$.proxy(this.onToStage,this)),$(document).bind("offStage",$.proxy(this.onOffStage,this)),$.getJSON("/shows/"+a+"/events",$.proxy(this.onEventsInit,this)),app.get("pusher").bind("state",$.proxy(this.onEventNew,this));if(app.get("role")==="moderator")return app.get("session").addEventListener("streamCreated",$.proxy(this.onStreamCreate,this))},onEventsInit:function(a){var b,c,d,e;e=[];for(c=0,d=a.length;c<d;c++)b=a[c],e.push(this.processEvent(b));return e},onEventNew:function(a){return this.processEvent(a)},processEvent:function(a){return this.get(a.user_id)?this.get(a.user_id).set({state:a.state}):this.add(new TownHall140.Models.Event({id:a.user_id,state:a.state}))},onToStage:function(a,b){return this.postEvent(b.id,"guest")},onOffStage:function(a,b){return this.postEvent(b.id,"queue")},onStreamCreate:function(a){var b,c;return c=a.streams[0],c.connection.connectionId===app.get("session").connection.connectionId?b="host":b="queue",this.postEvent(c.connection.data,b)},postEvent:function(a,b){var c,d;return d=app.get("show").id,c={user_id:a,state:b},$.ajax({type:"post",url:"/shows/"+d+"/events",data:{event:c}})}})})).call(this)